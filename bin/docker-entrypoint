#!/bin/bash -e

if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # orchestrate dependencies
  bundle exec rake orchestrator:start[postgresql] \
   orchestrator:start[redis] \
   orchestrator:await_healthy[postgresql] \
   orchestrator:await_healthy[redis] \
   orchestrator:connect_self

  # create connection environment variables
  eval $(bundle exec orchestrator:create_connection_environment[postgresql,redis])

  # prepare database
  bundle exec rake db:prepare
  FILTER=01_application_settings bundle exec rake db:seed_fu
fi

exec "${@}"
